<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>EXISAN UPLOADER</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class="bg-light">
<nav class="navbar bg-body-tertiary">
  <div class="container-fluid">
    <a class="navbar-brand"><i class="bi bi-upload"></i> EXISAN UPLOADER</a> 
    <form class="d-flex align-items-center" id="uploadForm">
      <input class="form-control me-2" type="file" id="fileInput" required>
      <button class="btn btn-outline-primary" type="submit">送信</button>
    </form>
  </div>
</nav>

<div class="container mt-4">
  <div id="statusContainer"></div>
</div>
<div class="container mt-4">
    <div id="statusContainer"></div>
    <div class="progress mt-2" style="height:20px; display:none;" id="progressWrapper">
      <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
    </div>
</div>
  
<script>
const FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSe-mSkpqwt_R3z35ZJ853HJ26GkzhLME5s1hWH0Al50ZOIMUQ/formResponse";

// Googleフォームの entry ID
const ENTRY_FILENAME = "entry.1024545454"; // ファイル名
const ENTRY_TOTAL    = "entry.1102220853"; // 総チャンク数
const ENTRY_INDEX    = "entry.59768090";   // このチャンク番号
const ENTRY_DATA     = "entry.295132291";  // チャンクデータ
const ENTRY_TOKEN    = "entry.204244672";  // トークン
const ENTRY_NAME = "entry.34087371"; //名前

function readFileAsBase64(file) {
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = () => rej(fr.error);
    fr.readAsDataURL(file);
  });
}

function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }

document.getElementById("uploadForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fileEl = document.getElementById("fileInput");
  if(!fileEl.files.length) return;

  const file = fileEl.files[0];
  const statusContainer = document.getElementById("statusContainer");
  const progressWrapper = document.getElementById("progressWrapper");
  const progressBar = document.getElementById("progressBar");

  statusContainer.innerHTML = `<div class="alert alert-info">ファイル読み込み中...</div>`;

  const base64Full = await readFileAsBase64(file);
  const b64 = base64Full.split(',')[1];

  const chunkSize = 30000;
  const chunks = [];
  for(let i=0;i<b64.length;i+=chunkSize) chunks.push(b64.slice(i,i+chunkSize));

  const token = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
  statusContainer.innerHTML = `<div class="alert alert-info">チャンク数: ${chunks.length} 送信開始...</div>`;
  const name = window.prompt('あなたのユーザー名を教えてください(匿名でもよい)');
  // プログレスバー表示
  progressWrapper.style.display = "block";
  progressBar.style.width = "0%";
  progressBar.innerText = "0%";

  for(let i=0;i<chunks.length;i++){
    const formData = new FormData();
    formData.append(ENTRY_FILENAME,file.name);
    formData.append(ENTRY_TOTAL,chunks.length);
    formData.append(ENTRY_INDEX,i);
    formData.append(ENTRY_DATA,chunks[i]);
    formData.append(ENTRY_TOKEN,token);
    formData.append(ENTRY_NAME,name); // 名前を匿名に設定

    try{
      await fetch(FORM_ACTION,{method:'POST',mode:'no-cors',body:formData});
    }catch(err){ console.warn(err);}
    
    // プログレス更新
    const percent = Math.round(((i+1)/chunks.length)*100);
    progressBar.style.width = percent + "%";
    progressBar.innerText = percent + "%";
    
    statusContainer.innerHTML = `<div class="alert alert-info">送信中: ${percent}%</div>`;
    await delay(200);
  }

  statusContainer.innerHTML = `<div class="alert alert-success">送信完了: ${file.name}<br>トークン: ${token}</div>`;
  progressWrapper.style.display = "none";
  fileEl.value = '';
});

</script>
</body>
</html>
